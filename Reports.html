<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Результаты тестирований</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="cssreset.css">
  <link rel="stylesheet" type="text/css" href="reports.css">
</head>
<body>

<header class="header">
  <h2>Анализ тестирований</h1>
</header>

<section class='main-report'>
  <form action="javascript:showQuizzes()">
    <fieldset>
      <p>Выберите период тестирований: </p>
      <label for="qr-start">Начальная дата:</label>
      <input type="date" id="qr-start" name="qr-start">
      <label for="qr-end">Конечная дата:</label>
      <input type="date" id="qr-end" name="qr-end">
      <input type="submit" value = 'Получить данные'/>
    </fieldset>
  </form>
  
  <div class='add-quiz'>
    <button id='addQuiz' class="btn btn-info">Показать форму Quiz-a</button>
    <form action="#" name='addquiz' class = 'add-quiz-form hidden-form' onsubmit="addQuiz()">
      <fieldset>
        <p>Введите данные quiz-а: </p>
        <label for="q-name">Наименование: </label>
        <input type="text" id="q-name" name="q-name" placeholder="например, Family&Friends Unit1">
        <br>
        <label for="q-program">Программа:</label>
        <input type="text" id="q-program" name="q-program" placeholder="например, GEa2">
        </br>
        <label for="q-unit">Unit:</label>
        <input type="number" id="q-unit" name="q-unit" min="0" max="20" value='0'>
        <input type="submit" value = 'Сохранить'/>
      </fieldset>
      <p id='add-result'></p>
    </form>
  </div>

  <div class='qr-data-container well hidden'>
    <h3 id='qr-list-title'>Список тестирований: </h3>
    <!--div class='text-center filter'>Введите часть названия или ФИО для поиска: 
      <input id="filter-input" type="text" placeholder="Поиск...">
    </div-->
    <div class="qr-data"></div>
  </div>
</section>

<section class="report-section hidden">
  <p>
    Сформировать отчеты: 
    <button id='teach-rep' class="btn btn-info">Преподаватели и курсы</button>
    <button id='all-rep' class="btn btn-info">Excel: выгрузка тестирований</button>
  </p>
</section>

<section id = 'detail-report' class='hidden'>
  <div>
    <div class="qr-detail"></div>
  </div>
</section>


<!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script> -->
  <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script> -->
  <script src="./js/jQuery.resizableColumns.js"></script>
  
  <script src="./js/addQuiz.js"></script>
  

  <script>
      let d = new Date();
      d.setDate(d.getDate() - 5);
      document.getElementById('qr-start').valueAsDate = d;
      document.getElementById('qr-end').valueAsDate = new Date();
      
      let addQuizBtn = document.querySelector('#addQuiz');
      addQuizBtn.addEventListener("click", function(e){
        document.querySelector('.add-quiz-form').classList.toggle('hidden-form');
        if (addQuizBtn.textContent == 'Показать форму Quiz-a') {
          addQuizBtn.textContent = 'Закрыть форму Quiz-a';
        } else {
          addQuizBtn.textContent = 'Показать форму Quiz-a';
        }
        
      });
    
      function showQuizzes() {
        let xmlhttp = new XMLHttpRequest();
          xmlhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                document.querySelector(".qr-data").innerHTML = this.responseText;
                addQuizResultRowHandlers();
              }
          };
          let d1 = document.getElementById('qr-start').value;
          let d2 = document.getElementById('qr-end').value;
          let qstr = `${d1}&d2=${d2}`;
          xmlhttp.open("GET", `./reports/quiz_results.php?d1=${qstr}` , true);
          xmlhttp.send();
          //document.querySelector("#qr-list-title").classList.remove('hidden');
          document.querySelector(".qr-data-container").classList.remove('hidden');
          document.querySelector("#detail-report").classList.remove('hidden');
          document.querySelector(".report-section").classList.remove('hidden');

      }
    
      function addQuizResultRowHandlers() {
        if (document.getElementById("qr-table")) {
          var rows = document.getElementById("qr-table").rows;
          for (i = 0; i < rows.length; i++) {
            rows[i].addEventListener("click", function(e){
              let selected = document.querySelector('#qr-body .selected');
              if (selected) {
                selected.classList.remove('selected');
              }
              e.target.parentNode.classList.add('selected');
              let qr_rowData = {};
              let col_names =[`rNum`, `quiz_code`, `fio`, `stud_code`, `teacher`, `user_score`, `pass_score`, `stud_percent`, `finished_at`, `quiz_time`, `qr_id`];
              Array.prototype.forEach.call(e.target.parentNode.cells, 
                (elem, i) => { qr_rowData[col_names[i]] = elem.textContent;
              });
              //console.log(qr_rowData);
              showQuizDetais(qr_rowData['qr_id']);
            })
          }
        };
      }
      
      function showQuizDetais(qr_id) {
        let xmlhttp = new XMLHttpRequest();
          xmlhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                document.querySelector(".qr-detail").innerHTML = this.responseText;
                $('table.resizable').resizableColumns();
              }
          };
          xmlhttp.open("GET", `./reports/quiz_detail.php?qr_id=${qr_id}` , true);
          xmlhttp.send();
      }
    
      $(document).ready(function(){
        $("#filter-input").on("keyup", function() {
          var value = $(this).val().toLowerCase();
          $("#qr-body tr").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
          });
        });
      });
      
      let btnTeachRep = document.getElementById('teach-rep');
      btnTeachRep.addEventListener("click", function(event){
        let xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              document.querySelector(".qr-detail").innerHTML = this.responseText;
            }
        };
        let d1 = document.getElementById('qr-start').value;
        let d2 = document.getElementById('qr-end').value;
        let qstr = `${d1}&d2=${d2}`;
        xmlhttp.open("GET", `./reports/teach-report.php?d1=${qstr}` , true);
        xmlhttp.send();
      });

      let btnAllRep = document.getElementById('all-rep');
      btnAllRep.addEventListener("click", function(event){
        let d1 = document.getElementById('qr-start').value;
        let d2 = document.getElementById('qr-end').value;
        let qstr = `${d1}&d2=${d2}`;
        window.location.href = `./reports/quest-report.php?d1=${qstr}`;
      });

      function addQuiz() {
        let xmlhttp = new XMLHttpRequest();
          xmlhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                document.querySelector("#add-result").innerHTML = this.responseText;
              }
          };
          let qProgram = document.querySelector('#q-program').value;
          let qUnit = document.querySelector('#q-unit').value;
          let qCode = `${qProgram}_${qUnit}`;

          var formData = new FormData(document.forms.addquiz);
          // добавить к пересылке ещё пару ключ - значение
          formData.append("q-code", qCode);
          // отослать
          xmlhttp.open("POST", `./reports/addQuiz.php` , true);
          xmlhttp.send(formData);
      }

    </script>

</body>
</html>