<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<title>Результаты тестирований</title>
  <link rel="stylesheet" type="text/css" href="reports.css">
</head>
<body>

<header class="header">
  <h2>Анализ тестирований</h1>
</header>

<section class='main-report'>
  <form action="javascript:showQuizzes()">
    <fieldset>
      <legend>Выберите период тестирований: </legend>
      <label for="qr-start">Начальная дата:</label>
      <input type="date" id="qr-start" name="qr-start">
      <label for="qr-end">Конечная дата:</label>
      <input type="date" id="qr-end" name="qr-end">
      <input type="submit" value = 'Получить данные'/>
    </fieldset>
  </form>
  <div>
    <h3 id='qr_list_title' class = 'hidden'>Список тестирований: </h3>
    <div class="qr-data"></div>
  </div>
</section>

<section id = 'detail-report' class='hidden'>
  <div>
    <h3 id = 'qr_detail_title' class = 'hidden'>Подробные данные: </h3>
    <div class="qr-detail"></div>
  </div>
</section>

<script>
  document.getElementById('qr-start').valueAsDate = new Date();
  document.getElementById('qr-end').valueAsDate = new Date();

  function showQuizzes() {
    let xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            document.querySelector(".qr-data").innerHTML = this.responseText;
            addQuizResultRowHandlers();
          }
      };
      let d1 = document.getElementById('qr-start').value;
      let d2 = document.getElementById('qr-end').value;
      let qstr = `${d1}&d2=${d2}`;
      xmlhttp.open("GET", `./reports/quiz_results.php?d1=${qstr}` , true);
      xmlhttp.send();
      document.querySelector("#qr_list_title").classList.remove('hidden');
  }

  function addQuizResultRowHandlers() {
    var rows = document.getElementById("qr-table").rows;
    for (i = 0; i < rows.length; i++) {
      rows[i].addEventListener("click", function(e){
        let selected = document.querySelector('#qr-table .selected');
        if (selected) {
          selected.classList.remove('selected');
        }
        e.target.parentNode.classList.add('selected');
        let qr_rowData = {};
        let col_names =[`rNum`, `quiz_code`, `fio`, `stud_code`, `teacher`, `user_score`, `pass_score`, `finished_at`, `quiz_time`, `qr_id`];
        Array.prototype.forEach.call(e.target.parentNode.cells, 
          (elem, i) => { qr_rowData[col_names[i]] = elem.textContent;
        });
        //console.log(qr_rowData);
        showQuizDetais(qr_rowData['qr_id']);
      })
    }
  }
  
  function showQuizDetais(qr_id) {
    let xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            document.querySelector(".qr-detail").innerHTML = this.responseText;
          }
      };
      xmlhttp.open("GET", `./reports/quiz_detail.php?qr_id=${qr_id}` , true);
      xmlhttp.send();
      document.querySelector("#detail-report").classList.remove('hidden');
  }


</script>


</body>
</html>