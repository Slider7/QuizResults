<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Результаты тестирований</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="cssreset.css">
  <link rel="stylesheet" type="text/css" href="reports.css">
</head>
<body>

<header class="header">
  <h2>Анализ тестирований</h1>
</header>

<section class='main-report'>
  <form action="#">
    <fieldset>
      <p>Выберите преподавателя: </p>    
      <select name="teacher" id='teach-select'> 
        <option value="Zhainarbayeva">Жайнарбаева</option>
        <option value="Zinatullina">Зинатуллина</option>
        <option value="Kaipov">Каипов</option>
        <option value="Seisembekova">Сейсембекова</option>
      </select>
      <br>
      <label for="isPeriod">Учитывать период тестирований</label>
      <input type="checkbox" value="0" name="isPeriod" id='isPeriod' onchange="checkPeriod()">
    </fieldset>
    <fieldset class = 'none' id='period'>
      <label for="qr-start">Начальная дата:</label>
      <input type="date" id="qr-start" name="qr-start" onchange="selectTeacher()">
      <label for="qr-end">Конечная дата:</label>
      <input type="date" id="qr-end" name="qr-end" onchange="selectTeacher()">
    </fieldset>
    <!-- input type="submit" value = 'Получить данные'/ -->
  </form>
</section>

 <main id='qr-data-container' class='hidden'>
  <div class='teach-quiz'>
    <h3 id='qr-list-title'>Quiz-ы преподавателя: </h3>
    <!--
    <div class='text-center filter'>Введите часть названия или ФИО для поиска: 
      <input id="filter-input" type="text" placeholder="Поиск...">
    </div>
    -->
    <div class="qr-data"></div>
  </div>
  
  <div id='detail-report' class='hidden'>
    <h4>Результаты тестов по выбранному Quiz-у: </h4>
    <div class="qr-detail"></div>
  </div>
</main>

<section class="quest-list">
  <div class="answer-list"></div>
</section>

<!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script> -->
  <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script> -->
  <script src="./js/jQuery.resizableColumns.js"></script>
  
  <script>
      let d = new Date();
      d.setDate(d.getDate() - 30);
      document.getElementById('qr-start').valueAsDate = d;
      document.getElementById('qr-end').valueAsDate = new Date();

      function checkPeriod(){ 
        document.getElementById('period').classList.toggle('none');
      }
      
      function selectTeacher(e){
        document.querySelector("#qr-data-container").classList.add('hidden');
        document.querySelector("#detail-report").classList.add('hidden');
        let elem = document.querySelector("#teach-select");
        let teacher_fio = elem.options[elem.selectedIndex].value;
        let xmlhttp = new XMLHttpRequest();
          xmlhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                document.querySelector(".qr-data").innerHTML = this.responseText;
                document.querySelector("#qr-data-container").classList.remove('hidden');
                addTeachQuizRowHandlers();
              }
          };
        xmlhttp.open("GET", `./reports/teacher_quiz.php?teacher=${teacher_fio}${getPeriodQuery()}` , true);
        xmlhttp.send();
      };

      document.getElementById('teach-select').addEventListener("change", selectTeacher, false);
      
      function addTeachQuizRowHandlers() {
        if (document.getElementById("teach-quiz-table")) {
          var rows = document.getElementById("teach-quiz-table").rows;
          for (i = 0; i < rows.length; i++) {
            rows[i].addEventListener("click", function(e){
              let selected = document.querySelector('#qr-body .selected');
              let teacher_fio = document.querySelector("#teach-select").value;
              if (selected) {
                selected.classList.remove('selected');
              }
              e.target.parentNode.classList.add('selected');
              let qr_rowData = {};
              let col_names =[`rNum`, `quiz_name`, `quiz_code`, `qr_cnt`];
              Array.prototype.forEach.call(e.target.parentNode.cells, 
                (elem, i) => { qr_rowData[col_names[i]] = elem.textContent;
              });
              showStudentQuizDetais(qr_rowData['quiz_code'], teacher_fio);
            })
          }
        };
      }

      function showStudentQuizDetais(quiz_code, teacher) {
        let xmlhttp = new XMLHttpRequest();
          xmlhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                document.querySelector(".qr-detail").innerHTML = this.responseText;
                addStudentRowHandlers();
              }
          };
          xmlhttp.open("GET", `./reports/teacher_quiz_students_list.php?quiz_code=${quiz_code}&teacher=${teacher}${getPeriodQuery()}` , true);
          xmlhttp.send();
          document.querySelector("#detail-report").classList.remove('hidden');
          document.querySelector("#qr-data-container").classList.remove('hidden');
      }

      
      /*--тут нужно дописать--*/
      function addStudentRowHandlers() {
        if (document.getElementById("qr-detail-table")) {
          var rows = document.getElementById("qr-detail-table").rows;
          for (i = 0; i < rows.length; i++) {
            rows[i].addEventListener("click", function(e){
              let selected = document.querySelector('#stud-list-body .selected');
              if (selected) {
                selected.classList.remove('selected');
              }
              e.target.parentNode.classList.add('selected');
              let stud_rowData = [];
              Array.prototype.forEach.call(e.target.parentNode.cells, 
                (elem, i) => { stud_rowData.push(elem.textContent);
              });
              console.log(stud_rowData);
              showTeacherQuizDetais(stud_rowData[8]);
            })
          }
        };
      }

      function showTeacherQuizDetais(qr_id) {
        let xmlhttp = new XMLHttpRequest();
          xmlhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                document.querySelector(".answer-list").innerHTML = this.responseText;
              }
          };
        xmlhttp.open("GET", `./reports/teacher_quiz_detail.php?qr_id=${qr_id}` , true);
        xmlhttp.send();
        document.querySelector(".answer-list").classList.remove('hidden');
      }

      function getPeriodQuery(){
        if (!document.getElementById('isPeriod').checked) return ``;
        let d1 = document.getElementById('qr-start').value;
        let d2 = document.getElementById('qr-end').value;
        return `&d1=${d1}&d2=${d2}`;
      }

    </script>

</body>
</html>